#!/bin/bash

# shellcheck disable=SC1090
. "$HOME/.bootstrappyrc"

toolname="$(basename "$0")"
progname="bootstrappy-$toolname"

die() {
  printf "\033[0;38;2;200;15;15m%s\033[0m: error: " "$progname" >&2
  printf "%s" "$@" >&2
  printf "\n" >&2
  exit 1
}

install() {
  package=$1
  echo "$0: installing $package"
  ( pip install "$package" >&2 ) || die "failed to install $package"
}
envdir="$HOME/.bootstrappy/$toolname"
activate="$envdir/bin/activate"

if ! [[ -f "$activate" ]]; then
  ( python3 -mvenv "$envdir" >&2 ) || die "unable to make a virtualenv [envdir=$envdir]"
  if ! [[ -f "$activate" ]]; then
    die "could not create virtual env"
  fi
  # shellcheck disable=SC1090
  . "$activate" || die "python env is not set up [envdir=$envdir]"
  if ( [ -n "${!toolname}" ] ); then
    # User has defined an override for this toolname's installation package.
    install "${!toolname}"
  else
    # Use the toolname itself as an installation package.
    install "$toolname"
  fi
else
  # shellcheck disable=SC1090
  . "$activate" || die "python env is not set up [envdir=$envdir]"
fi

if [[ "$(realpath "$(command -v "$toolname")")" == "$(realpath "$0")" ]]; then
  die "tool resolves back to bootstrappy [toolname=$toolname]"
fi
exec "$toolname" "$@"
