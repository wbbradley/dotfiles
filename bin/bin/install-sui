#!/bin/bash

cd "$HOME"/src/walrus
version="$(
  git grep sui-sdk.=..*MystenLabs/sui \
    | grep -o ' tag = ".*"' \
    | awk -F\" '{ print $2 }'
)"

echo "Walrus is currently pointing at Sui $version..."

if [[ "$(uname)" = "Darwin" ]]; then
  filename="sui-$version-macos-$(uname -m).tgz"
  url="https://github.com/MystenLabs/sui/releases/download/$version/$filename"
else
  filename="sui-$version-ubuntu-x86_64.tgz"
  url="https://github.com/MystenLabs/sui/releases/download/$version/$filename"
fi

echo "Looking for $url [version=$version]..."

# Make a temp dir
tempdir="$(mktemp -d)"
trap 'rm -rf '"$tempdir" EXIT

echo "Downloading $filename from $url..."
curl -LO "$url"

echo "Moving $filename to $tempdir..."
mv "$filename" "$tempdir"/

cd "$tempdir"

echo "Extracting $filename..."
tar -xzf "$filename"

echo "Moving binaries to $HOME/.local/bin..."
find . -type f -print -exec mv {} "$HOME"/.local/bin/ \;

echo "Running sui --version..."
"$HOME"/.local/bin/sui --version
